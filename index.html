<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Data Logger App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f2f2f2; }
    h2 { text-align: center; }
    #data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #data-table th, #data-table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    #download { margin-top: 20px; display: block; width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; font-size: 16px; border-radius: 4px; cursor: pointer; }
    #download:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <h2>Improved Data Logger</h2>
  <table id="data-table">
    <thead>
      <tr>
        <th>Sl No</th>
        <th>Date</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Is 5G (0/1)</th>
        <th>Latency (ms)</th>
        <th>Ping (ms)</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
  <button id="download">Download CSV</button>

  <script>
    let serial = 1;
    const tableBody = document.getElementById("table-body");

    // 1. Improved 5G Detection
    function is5GConnection() {
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (connection) {
        const effective = connection.effectiveType;
        const type = connection.type || "";
        if (effective === "5g" || type.toLowerCase().includes("5g")) return 1;
      }
      return 0;
    }

    // 2. Latency (measured using fetch)
    async function getLatency() {
      const start = performance.now();
      try {
        await fetch("https://corsproxy.io/?https://example.com", { method: "GET" });
      } catch (e) {}
      const end = performance.now();
      return Math.round(end - start);
    }

    // 3. Ping time (by loading a small image)
    async function getPing() {
      return new Promise(resolve => {
        const img = new Image();
        const start = performance.now();
        img.onload = () => resolve(Math.round(performance.now() - start));
        img.onerror = () => resolve(Math.round(performance.now() - start));
        img.src = "https://www.google.com/favicon.ico?" + Date.now(); // prevent cache
      });
    }

    // Log row into table
    function logData(lat, lon, latency, ping, is5g) {
      const row = document.createElement("tr");
      const date = new Date().toISOString().split("T")[0];
      [serial++, date, lat, lon, is5g, latency, ping].forEach(val => {
        const cell = document.createElement("td");
        cell.textContent = val;
        row.appendChild(cell);
      });
      tableBody.appendChild(row);
    }

    // Main data collector
    async function collectData() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
          const lat = position.coords.latitude.toFixed(6);
          const lon = position.coords.longitude.toFixed(6);
          const latency = await getLatency();
          const ping = await getPing();
          const is5g = is5GConnection();
          logData(lat, lon, latency, ping, is5g);
        }, (err) => {
          alert("GPS access denied. Cannot collect data.");
        });
      } else {
        alert("Geolocation not supported.");
      }
    }

    // CSV Download
    document.getElementById("download").addEventListener("click", () => {
      let csv = "sl_no,date,latitude,longitude,is_5g,latency_ms,ping_ms\n";
      Array.from(tableBody.children).forEach(row => {
        const rowData = Array.from(row.children).map(td => `"${td.textContent}"`).join(",");
        csv += rowData + "\n";
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "data_log.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Ask permission and start logging
    window.onload = () => {
      if (confirm("Do you allow the app to collect GPS and network data?")) {
        collectData();
      }
    };
  </script>
</body>
</html>
